# Bot-sysadmin

Telegram-бот для приёма заявок на техподдержку с распределением по администраторам.

## Возможности

### Пользователь
- Создание заявки через ЛС бота с выбором категории, приоритета и описанием (текст/фото)
- Просмотр своих заявок (`/my`)
- Проверка статуса заявки (`/status #00001`)
- Переписка с админом через бота (ответ на заявку)

### Администратор
- Уведомления о новых заявках в чате админов
- Кнопка «Взять в работу» — заявка закрепляется за админом
- Три способа ответить пользователю:
  - `/reply #00001 текст` — команда
  - Reply на сообщение заявки в чате админов
  - Кнопка «Ответить» на заявке → reply на prompt-сообщение
- Смена приоритета (`/priority #00001 high`)
- Закрытие заявки (кнопка или `/close #00001`)
- Список открытых заявок (`/tickets`)

### Старший админ
- Добавление/удаление администраторов (`/addadmin`, `/removeadmin`)
- Список администраторов (`/admins`)

## Стек

- Python 3.12, aiogram 3.x
- SQLite (aiosqlite) + SQLAlchemy 2.x async
- Docker

## Быстрый старт

```bash
cp .env.example .env
# Заполнить BOT_TOKEN, ADMIN_CHAT_ID, SENIOR_ADMIN_IDS

docker compose up --build -d
```

### Переменные окружения

| Переменная | Описание |
|---|---|
| `BOT_TOKEN` | Токен Telegram-бота |
| `ADMIN_CHAT_ID` | ID группы администраторов |
| `SENIOR_ADMIN_IDS` | ID старших админов через запятую |
| `DATABASE_URL` | Строка подключения к БД (по умолчанию SQLite) |
| `LOG_LEVEL` | Уровень логирования (INFO/DEBUG) |

## Структура проекта

```
bot/
├── main.py           — точка входа
├── config.py         — конфигурация из .env
├── db/
│   ├── models.py     — модели (User, Admin, Ticket, TicketMessage)
│   └── database.py   — подключение к БД
├── handlers/
│   ├── common.py     — /start, /help, /cancel
│   ├── user.py       — создание заявки, ответ пользователя, мои заявки
│   └── admin.py      — взятие/закрытие заявок, ответы админа
├── keyboards/
│   └── inline.py     — inline-клавиатуры
├── middlewares/
│   └── access.py     — проверка прав доступа
└── utils/
    └── ticket.py     — форматирование и генерация номеров
```

## Команды

| Команда | Роль | Описание |
|---|---|---|
| `/start` | все | Главное меню |
| `/help` | все | Список команд |
| `/new` | пользователь | Создать заявку |
| `/my` | пользователь | Мои заявки |
| `/status #N` | пользователь | Статус заявки |
| `/cancel` | все | Отменить текущее действие |
| `/tickets` | админ | Открытые заявки |
| `/reply #N текст` | админ | Ответить на заявку |
| `/close #N` | админ | Закрыть заявку |
| `/priority #N low/medium/high` | админ | Сменить приоритет |
| `/addadmin ID` | ст. админ | Добавить админа |
| `/removeadmin ID` | ст. админ | Удалить админа |
| `/admins` | ст. админ | Список админов |

## Управление

```bash
# Запуск
docker compose up --build -d

# Логи
docker compose logs -f

# Остановка
docker compose down
```

БД хранится в `./data/bot.db` и сохраняется между перезапусками через Docker volume.
